<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßá‡¶ú</title>
    <style>
      /* ‡¶®‡ßç‡¶Ø‡¶æ‡¶≠‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: #007bff;
    padding: 10px 20px;
    color: white;
}

/* ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
#navSelect {
    padding: 5px;
    border: none;
    border-radius: 4px;
}

/* ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.icon-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    margin-left: 10px;
}

.icon-btn:hover {
    color: #ddd;
}
/* ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.dropdown-menu {
    display: none;
    position: absolute;
    top: 60px;
    right: 80px;
    background: white;
    color: black;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    width: 200px;
    text-align: center;
}

/* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° */
.dropdown-menu input {
    width: 90%;
    padding: 5px;
    margin: 5px 0;
}

/* ‡¶∏‡ßá‡¶≠ ‡¶¨‡¶æ‡¶ü‡¶® */
#saveButton {
    padding: 5px 10px;
    border: none;
    background: #28a745;
    color: white;
    cursor: pointer;
    border-radius: 4px;
}

#saveButton:hover {
    background: #218838;
}
.dropdown-menu {
  display: none;
    position: absolute;
    top: 60px;
    right: 10px;
    background: white;
    color: black;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    width: 200px;
    text-align: center;
    z-index: 1000;
}
.dropdown-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.dropdown-menu li {
  padding: 5px;
  border-bottom: 1px solid black;
}
/* üîπ ‡¶™‡¶™‡¶Ü‡¶™ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° (‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶™‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü) */
.popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* üîπ ‡¶™‡¶™‡¶Ü‡¶™ ‡¶ï‡¶®‡¶ü‡ßá‡¶®‡ßç‡¶ü */
.popup-content {
    background: white;
    padding: 20px;
    width: 350px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    animation: fadeIn 0.3s ease-in-out;
}

/* üîπ ‡¶π‡ßá‡¶°‡¶ø‡¶Ç */
.popup-content h2 {
    margin-bottom: 15px;
    font-size: 20px;
    color: #333;
}

/* üîπ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° */
.popup-content label {
    display: block;
    text-align: left;
    margin: 8px 0 5px;
    font-size: 14px;
    color: #555;
}

.popup-content input {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

/* üîπ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
.popup-content button {
    width: 48%;
    padding: 10px;
    margin-top: 10px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: 0.3s;
}

/* üîπ Save ‡¶¨‡¶æ‡¶ü‡¶® */
#saveProduct {
    background: #28a745;
    color: white;
}

#saveProduct:hover {
    background: #218838;
}

/* üîπ Cancel ‡¶¨‡¶æ‡¶ü‡¶® */
#cancelProduct {
    background: #dc3545;
    color: white;
}

#cancelProduct:hover {
    background: #c82333;
}

/* üîπ Fade In Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
/* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
.table-container {
    max-height: 700px;
    overflow-y: auto;
    border: 1px solid #ccc;
}

/* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
table {
    border-collapse: collapse;
    table-layout: fixed; /* ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶†‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø ‡¶ï‡¶∞‡¶¨‡ßá */
}

/* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ø‡¶ï‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá */
thead {
    position: sticky;
    top: 0;
    background-color: #f8f8f8;
    z-index: 10;
}

/* ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    white-space: nowrap; /* ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶≠‡¶æ‡¶ô‡¶§‡ßá ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ */
}

/* ‚úÖ ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡ßá‡¶á‡¶Æ ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ */
th:nth-child(2), td:nth-child(2) {
    min-width: 200px;
    text-align: center;
    white-space: nowrap; /* ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø-‡¶≤‡¶æ‡¶á‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
}
    </style>
</head>
<body>
    <nav class="navbar">
        <!-- ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® -->
        <select id="navSelect">
          
        </select>

        <!-- "+" ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
        <button id="addButton" class="icon-btn"> üÜî
        </button>
                <!-- ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶° ‡¶¨‡¶æ‡¶ü‡¶® -->
       <button id="openProductForm" class="icon-btn">‡¶è‡¶°‡¶° </button>

        <!-- ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
        <button id="detailsButton" class="icon-btn">
            üîΩ
        </button>
    </nav>
    
    <div id="addDropdown" class="dropdown-menu">
    <h3>‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡ßá‡¶ñ‡ßÅ‡¶®</h3>
    <input type="text" id="companyNameInput" placeholder="‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ">
    <button id="saveButton">‡¶∏‡ßá‡¶≠</button>
</div>

<!-- "‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏" ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
<div id="detailsDropdown" class="dropdown-menu">
    <ul> </ul>
</div>

<!-- ‡¶™‡¶™‡¶Ü‡¶™ ‡¶´‡¶∞‡ßç‡¶Æ -->
<div id="productFormPopup" class="popup">
    <div class="popup-content">
        <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>

        <label for="productName">‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡ßá‡¶á‡¶Æ:</label>
        <input type="text" id="productName">

        <label for="productNumber">‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞:</label>
        <input type="number" id="productNumber">

        <label for="purchasePrice">‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</label>
        <input type="number" id="purchasePrice">

        <label for="sellingPrice">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</label>
        <input type="number" id="sellingPrice">

        <label for="stockQuantity">‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ:</label>
        <input type="text" id="stockQuantity">

        <label for="damage">‡¶°‡ßá‡¶Æ‡ßá‡¶ú:</label>
        <input type="number" id="damage">

        <button id="saveProduct" onclick="saveProductData()">Save</button>
        <button id="cancelProduct">Cancel</button>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>‡¶®‡¶Ç</th>
                <th>‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡ßá‡¶á‡¶Æ</th>
                <th>‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                <th>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                <th>‡¶∏‡ßç‡¶ü‡¶ï</th>
                <th>‡¶∏‡ßç‡¶ü‡¶ï‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                <th>‡¶°‡ßá‡¶Æ‡ßá‡¶ú</th>
                <th>‡¶°‡ßá‡¶Æ‡ßá‡¶ú‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
    </table>
</div>

<script type="module" src="firebase.js"></script>
<script type="module">
  // Import Firebase modules from firebase.js (‡¶è‡¶ñ‡¶æ‡¶®‡ßá firebase.js ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø import ‡¶ï‡¶∞‡ßÅ‡¶®)
  import { db, auth } from "./firebase.js";
  import {
    collection,
    doc,
    getDoc,
    getDocs,
    setDoc,
    updateDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

  // ----------------------------------------------------
  // ‡ßß. UI - Dropdown (‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø ‡¶ì ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏) ‡¶ü‡¶ó‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  document.addEventListener("DOMContentLoaded", function () {
    const addButton = document.getElementById("addButton");
    const addDropdown = document.getElementById("addDropdown");
    const detailsButton = document.getElementById("detailsButton");
    const detailsDropdown = document.getElementById("detailsDropdown");

    addButton.addEventListener("click", function (event) {
      event.stopPropagation();
      toggleDropdown(addDropdown);
    });

    detailsButton.addEventListener("click", function (event) {
      event.stopPropagation();
      toggleDropdown(detailsDropdown);
    });

    function toggleDropdown(menu) {
      if (menu.style.display === "block") {
        menu.style.display = "none";
      } else {
        closeAllDropdowns();
        menu.style.display = "block";
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll(".dropdown-menu").forEach(menu => {
        menu.style.display = "none";
      });
    }

    document.addEventListener("click", function (event) {
      if (!addButton.contains(event.target) && !addDropdown.contains(event.target) &&
          !detailsButton.contains(event.target) && !detailsDropdown.contains(event.target)) {
        closeAllDropdowns();
      }
    });
  });

  // ----------------------------------------------------
  // ‡ß®. ‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ì ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
  document.getElementById("saveButton").addEventListener("click", async function () {
    let companyName = document.getElementById("companyNameInput").value.trim();
    if (companyName === "") {
      alert("‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
      return;
    }
    // ‡¶∏‡ßç‡¶™‡ßá‡¶∏ (_) ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
    companyName = companyName.replace(/\s+/g, "_");

    try {
      // 'companyAll' ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø
      await setDoc(doc(db, "companyAll", companyName), {});
      alert("‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
      document.getElementById("companyNameInput").value = "";
      loadCompanyNames();
    } catch (error) {
      console.error("Error saving company:", error);
      alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
    }
  });

  const navSelect = document.getElementById("navSelect");

  async function loadCompanyNames() {
    try {
      // ‡¶®‡ßá‡¶ü ‡¶Ö‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá default, ‡¶®‡ßá‡¶ü ‡¶Ö‡¶´ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá cache ‡¶•‡ßá‡¶ï‡ßá
      const querySnapshot = await getDocs(collection(db, "companyAll"), 
        navigator.onLine ? {} : { source: "cache" });
      
      navSelect.innerHTML = "";
      let fragment = document.createDocumentFragment();
      querySnapshot.forEach((docSnap) => {
        let option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = docSnap.id.replace(/_/g, " ");
        fragment.appendChild(option);
      });
      navSelect.appendChild(fragment);

      // renderProductTable ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
      if (typeof window.renderProductTable === "function") {
        window.renderProductTable();
      } else {
        console.error("renderProductTable ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
      }
    } catch (error) {
      console.error("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá:", error);
    }
  }

  // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶°
  document.addEventListener("DOMContentLoaded", loadCompanyNames);
  navSelect.addEventListener("change", function () {
    if (typeof window.renderProductTable === "function") {
      window.renderProductTable();
    } else {
      console.error("renderProductTable ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
    }
  });

  // ----------------------------------------------------
  // ‡ß©. ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡¶™‡¶Ü‡¶™ ‡¶ñ‡ßã‡¶≤‡¶æ/‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
  document.getElementById("openProductForm").addEventListener("click", function () {
    document.getElementById("productFormPopup").style.display = "flex";
    // ‡¶™‡¶™‡¶Ü‡¶™ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶ï‡¶∞‡¶æ
    document.getElementById("productName").value = "";
    document.getElementById("productNumber").value = "";
    document.getElementById("purchasePrice").value = "";
    document.getElementById("sellingPrice").value = "";
    document.getElementById("stockQuantity").value = "";
    document.getElementById("damage").value = "";
  });

  document.getElementById("cancelProduct").addEventListener("click", function () {
    document.getElementById("productFormPopup").style.display = "none";
  });

  document.getElementById("saveProduct").addEventListener("click", function () {
    document.getElementById("productFormPopup").style.display = "none";
  });

  // ----------------------------------------------------
  // ‡ß™. ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  window.calculateExpression = function (input) {
    try {
      return new Function(`return ${input}`)();
    } catch {
      return input;
    }
  };

  // ----------------------------------------------------
  // ‡ß´. ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (offline friendly)
  window.saveProductData = async function () {
    // ‡ßß. navSelect ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶≠‡ßá‡¶≤‡ßÅ, ‡¶∏‡ßç‡¶™‡ßá‡¶∏ (_) ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏
    let selectedValue = navSelect.value.trim().replace(/\s+/g, "_");
    if (!selectedValue) {
      alert("‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
      return;
    }
    // ‡ß®. Firestore ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
    const docRef = doc(db, "companyAll", selectedValue);
    let docSnap;
    try {
      // ‡¶®‡ßá‡¶ü ‡¶Ö‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá default, ‡¶®‡ßá‡¶ü ‡¶Ö‡¶´ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá cache ‡¶•‡ßá‡¶ï‡ßá
      docSnap = await getDoc(docRef, navigator.onLine ? {} : { source: "cache" });
    } catch (error) {
      console.error("Error fetching document:", error);
    }

    // ‡ß©. ‡¶™‡¶™‡¶Ü‡¶™‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡¶æ‡¶®
    let stockInput = document.getElementById("stockQuantity").value.trim();
    let calculatedStockQuantity = calculateExpression(stockInput);

    let productData = {
      productName: document.getElementById("productName").value.trim(),
      productNumber: document.getElementById("productNumber").value.trim(),
      purchasePrice: document.getElementById("purchasePrice").value.trim(),
      sellingPrice: document.getElementById("sellingPrice").value.trim(),
      stockQuantity: calculatedStockQuantity,
      damage: document.getElementById("damage").value.trim()
    };

    let productNumber = productData.productNumber;
    if (!productNumber) {
      alert("‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
      return;
    }

    let updatedData = {};
    updatedData[productNumber] = productData;

    try {
      if (docSnap && docSnap.exists()) {
        // ‡¶Ø‡¶¶‡¶ø ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶•‡¶æ‡¶ï‡ßá, update ‡¶ï‡¶∞‡ßÅ‡¶®
        await updateDoc(docRef, updatedData);
      } else {
        // ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá, ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
        await setDoc(docRef, updatedData);
      }
      alert("‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
      if (typeof window.renderProductTable === "function") {
        window.renderProductTable();
      }
    } catch (error) {
      console.error("Error saving product data:", error);
      alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
    }
  };

  // ----------------------------------------------------
  // ‡ß¨. ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡ßá‡¶ö ‡¶ì ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® (offline friendly)
  // ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (onSnapshot ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá)
window.renderProductTable = function () {
  let selectedValue = navSelect.value.trim().replace(/\s+/g, "_");
  if (!selectedValue) {

    return;
  }
  const docRef = doc(db, "companyAll", selectedValue);
  
  // onSnapshot() ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∂‡ßã‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ
  onSnapshot(docRef, { includeMetadataChanges: true }, (docSnap) => {
    if (!docSnap.exists()) {
      alert("‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
      return;
    }
    let data = docSnap.data();
    let tableBody = document.getElementById("productTableBody");
    tableBody.innerHTML = "";
    let fragment = document.createDocumentFragment();
    let rowIndex = 1;
    
    for (let productNumber in data) {
      let product = data[productNumber];
      let stockValue = Number(product.stockQuantity) || 0;
      let purchasePrice = Number(product.purchasePrice) || 0;
      let damageValue = Number(product.damage) || 0;
      let stockTotal = stockValue * purchasePrice;
      let damageTotal = damageValue * purchasePrice;
      let row = document.createElement("tr");
      row.innerHTML = `
          <td>${product.productNumber}</td>
          <td>${product.productName}</td>
          <td>${purchasePrice}</td>
          <td>${product.sellingPrice}</td>
          <td>${stockValue}</td>
          <td>${stockTotal.toFixed(2)}</td>
          <td>${damageValue}</td>
          <td>${damageTotal.toFixed(2)}</td>
          <td>
              <button onclick="editProduct(this.closest('tr'))">‚úèÔ∏è</button>
              <button onclick="saveProduct('${productNumber}')">üíæ</button>
          </td>
      `;
      fragment.appendChild(row);
      rowIndex++;
    }
    tableBody.appendChild(fragment);
    updateStockAndDamageSummary();
  }, (error) => {
    console.error("Error in onSnapshot:", error);
  });
};

  // ----------------------------------------------------
  // ‡ß≠. ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶°‡ßá‡¶Æ‡ßá‡¶ú ‡¶∏‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
  function updateStockAndDamageSummary() {
    let totalStockValue = 0;
    let totalDamageValue = 0;
    document.querySelectorAll("#productTableBody tr").forEach(row => {
      let stockVal = parseFloat(row.children[5].textContent) || 0;
      let damageVal = parseFloat(row.children[7].textContent) || 0;
      totalStockValue += stockVal;
      totalDamageValue += damageVal;
    });
    let detailsDropdown = document.getElementById("detailsDropdown");
    let ul = detailsDropdown.querySelector("ul");
    ul.innerHTML = "";
    let stockLi = document.createElement("li");
    stockLi.textContent = `‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ü‡¶ï‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: ${totalStockValue.toFixed(2)}`;
    ul.appendChild(stockLi);
    let damageLi = document.createElement("li");
    damageLi.textContent = `‡¶Æ‡ßã‡¶ü ‡¶°‡ßá‡¶Æ‡ßá‡¶ú‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: ${totalDamageValue.toFixed(2)}`;
    ul.appendChild(damageLi);
  }

  // ----------------------------------------------------
  // ‡ßÆ. ‡¶™‡ßç‡¶∞‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  window.editProduct = function (row) {
    // ‡¶∞‡ßã ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
    const productNumber = row.children[0].textContent; 
    const productName = row.children[1].textContent;
    const purchasePrice = row.children[2].textContent;
    const sellingPrice = row.children[3].textContent;
    const stockQuantity = row.children[4].textContent;
    const damage = row.children[6].textContent;
    // ‡¶™‡¶™‡¶Ü‡¶™ ‡¶´‡¶∞‡ßç‡¶Æ‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶≠‡¶∞‡ßç‡¶§‡¶ø
    document.getElementById("productName").value = productName;
    document.getElementById("productNumber").value = productNumber;
    document.getElementById("purchasePrice").value = purchasePrice;
    document.getElementById("sellingPrice").value = sellingPrice;
    document.getElementById("stockQuantity").value = stockQuantity;
    document.getElementById("damage").value = damage;
    document.getElementById("productFormPopup").style.display = "flex";
  };

  // ----------------------------------------------------
  // ‡ßØ. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶ö‡ßá‡¶ï (‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá)
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("User is logged in:", user.uid);
      window.renderProductTable();
    } else {
      console.error("User not logged in. Redirecting to login page.");
      window.location.href = "login.html";
    }
  });
</script>


</body>
</html>
